<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Papu Platformer – Spritesheet + Cubitos Power-Up</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0b1020; color: #e8eefc; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }
    canvas{ display:block; width:100vw; height:100vh; }
    #hud { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 16px; align-items: center; background: rgba(10, 14, 30, .7); border: 1px solid #1f2a44; border-radius: 12px; padding: 8px 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); user-select: none; pointer-events: none; font-weight: 600; }
    #hud span { opacity: .9 }
    #health { position: fixed; top: 10px; left: 10px; display: flex; gap: 6px; align-items: center; background: rgba(10, 14, 30, .7); border: 1px solid #1f2a44; border-radius: 12px; padding: 6px 10px; box-shadow: 0 10px 30px rgba(0,0,0,.25); user-select: none; }
    .heart { width: 18px; height: 16px; }
    #help { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(10, 14, 30, .7); border: 1px solid #1f2a44; border-radius: 12px; padding: 8px 12px; font-size: 14px; text-align: center; line-height: 1.4; user-select: none; }
    #overlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(5, 8, 18, .85); }
    #overlay .card{ background: #0b132b; border: 1px solid #1f2a44; border-radius: 16px; padding: 20px; text-align:center; width: min(92vw, 720px); box-shadow: 0 10px 40px rgba(0,0,0,.35) }
    #overlay h2 { margin: 0 0 10px }
    #overlay button{ margin-top: 10px; background: #3b82f6; color: white; border: none; border-radius: 10px; padding: 10px 16px; font-weight: 700; cursor: pointer }
    #overlay .row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    #overlay .ghost { background: transparent; color: #e8eefc; border: 1px solid #1f2a44; }
    #audioToggle { position: fixed; top: 10px; right: 10px; background: rgba(10, 14, 30, .7); border: 1px solid #1f2a44; border-radius: 12px; padding: 6px 10px; font-weight: 700; cursor: pointer; }
    #bossbar { position: fixed; top: 52px; left: 50%; transform: translateX(-50%); width: min(80vw, 560px); height: 14px; border: 1px solid #1f2a44; background: rgba(10,14,30,.6); border-radius: 8px; overflow: hidden; display: none; }
    #bossbar > div { height: 100%; background: linear-gradient(90deg, #f43f5e, #ef4444); width: 100%; }
    #touch { position: fixed; inset: 0; pointer-events: none; }
    .btn { position: absolute; bottom: 24px; width: 68px; height: 68px; border-radius: 50%; background: rgba(59,130,246,.25); border: 1px solid rgba(59,130,246,.45); pointer-events: auto; touch-action: none; display: grid; place-items: center; font-weight: 800; user-select: none; }
    .btn:active{ filter: brightness(1.2) }
    #btnLeft{ left: 24px } #btnRight{ left: 108px } #btnJump{ right: 24px; width:82px; height:82px; }
    #btnAtk{ right: 124px; width:72px; height:72px; bottom: 26px; }
  </style>
</head>
<body>
  <div id="health"></div>
  <div id="hud">
    <span id="level">Nivelazo: 1</span>
    <span id="coins">Moneditas: 0</span>
    <span id="timer">Crono: 0.0s</span>
  </div>
  <div id="bossbar"><div></div></div>
  <button id="audioToggle" title="Alternar audio">Audio: Off</button>
  <div id="help">Flechitas moverse · Espacio doble salto · X tunazo · C disparar cubitos (si pillas el power) · P pausa · R reinicia</div>
  <canvas id="game" width="1280" height="720"></canvas>

  <div id="overlay"><div class="card">
    <h2 id="ovTitle"></h2>
    <div id="ovBody" style="white-space:pre-line; margin:10px 0 0 0;"></div>
    <div id="ovActions" class="row" style="margin-top:12px;"></div>
  </div></div>

  <div id="touch" aria-hidden="true">
    <div class="btn" id="btnLeft">◀</div>
    <div class="btn" id="btnRight">▶</div>
    <div class="btn" id="btnJump">⤒</div>
    <div class="btn" id="btnAtk">✶</div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const hudCoins = document.getElementById('coins');
  const hudTimer = document.getElementById('timer');
  const hudLevel = document.getElementById('level');
  const healthHud = document.getElementById('health');
  const overlay = document.getElementById('overlay');
  const ovTitle = document.getElementById('ovTitle');
  const ovBody = document.getElementById('ovBody');
  const ovActions = document.getElementById('ovActions');
  const audioToggleBtn = document.getElementById('audioToggle');
  const bossbar = document.getElementById('bossbar');
  const bossFill = bossbar.firstElementChild;

  function fitCanvas() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = window.innerWidth, h = window.innerHeight;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  // --- Spritesheet ---
  let ATLAS = null;
  const SPR = {
    // Jugador (34x46 salvo attack 54x46)
    player_idle:  [{x:0,y:0,w:34,h:46},{x:36,y:0,w:34,h:46}],
    player_run:   [{x:0,y:48,w:34,h:46},{x:36,y:48,w:34,h:46},{x:72,y:48,w:34,h:46},{x:108,y:48,w:34,h:46}],
    player_jump:  [{x:0,y:96,w:34,h:46}],
    player_attack:[{x:36,y:96,w:54,h:46}],
    // Enemigos
    walker: [{x:120,y:0,w:28,h:24},{x:150,y:0,w:28,h:24}],
    turret: [{x:120,y:30,w:20,h:32},{x:142,y:30,w:20,h:32}],
    boss:   [{x:120,y:66,w:56,h:48},{x:178,y:66,w:56,h:48}],
    // Pickups/FX
    coin:  [{x:0,y:144,w:16,h:16},{x:18,y:144,w:16,h:16},{x:36,y:144,w:16,h:16},
            {x:54,y:144,w:16,h:16},{x:72,y:144,w:16,h:16},{x:90,y:144,w:16,h:16}],
    heart: [{x:120,y:120,w:16,h:16}],
    bullet:[{x:140,y:120,w:8,h:8}],
    cube:  [{x:152,y:120,w:14,h:14}],
    power: [{x:170,y:120,w:20,h:20}],
  };
  function drawSpr(frame, dx, dy, dw, dh, opts={}) {
    if (!ATLAS || !frame) return;
    const {flip=false, rot=0, alpha=1} = opts;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.translate(dx + dw/2, dy + dh/2);
    if (rot) ctx.rotate(rot);
    ctx.scale(flip?-1:1, 1);
    ctx.drawImage(ATLAS, frame.x, frame.y, frame.w, frame.h, -dw/2, -dh/2, dw, dh);
    ctx.restore();
  }
  function loadAtlas(src){
    return new Promise((res, rej)=>{
      const img = new Image();
      img.onload = ()=>{ ATLAS = img; res(); };
      img.onerror = rej;
      img.src = src; // e.g. sprites.png
    });
  }

  // --- Input ---
  const keys = new Set();
  window.addEventListener('keydown', e => {
    if (["ArrowLeft","ArrowRight"," ","Space","KeyR","KeyX","KeyC","KeyP","Enter"].includes(e.code)) e.preventDefault();
    keys.add(e.code);
  });
  window.addEventListener('keyup', e => keys.delete(e.code));

  function bindTouch(id, on, off) {
    const el = document.getElementById(id);
    const start = (e)=>{ e.preventDefault(); on(); }
    const end = (e)=>{ e.preventDefault(); off(); }
    el.addEventListener('touchstart', start, {passive:false});
    el.addEventListener('touchend', end, {passive:false});
    el.addEventListener('touchcancel', end, {passive:false});
    el.addEventListener('mousedown', start);
    el.addEventListener('mouseup', end);
    el.addEventListener('mouseleave', end);
  }
  let touchLeft=false, touchRight=false, touchJump=false, touchAtk=false;
  bindTouch('btnLeft', ()=>touchLeft=true, ()=>touchLeft=false);
  bindTouch('btnRight', ()=>touchRight=true, ()=>touchRight=false);
  bindTouch('btnJump', ()=>touchJump=true, ()=>touchJump=false);
  bindTouch('btnAtk', ()=>touchAtk=true, ()=>touchAtk=false);

  // --- Constantes ---
  const G = 1800, MOVE = 420, JUMP = 760, FRICTION = 0.82;

  const attack = { active:false, timer:0, duration:0.14, cooldown:0.28, cdLeft:0 };

  const state = {
    screen: 'menu',
    startedAt: performance.now(),
    time: 0,
    coins: 0,
    camera: {x:0, y:0},
    levelIndex: 0,
    maxLevels: 3,
    audioOn: false
  };

  const player = {
    x: 60, y: -200, w: 34, h: 46,
    vx: 0, vy: 0,
    onGround: false, canDouble: true,
    facing: 1,
    maxHp: 5, hp: 5,
    hurtCd: 0,
    hasBlaster: false,
    shootCd: 0
  };

  // --- Audio (simple synth) ---
  const AudioSys = (()=>{
    let ctx = null, master, musicGain, sfxGain;
    let started = false, musicInterval = null;
    function resume(){
      if (!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        master = ctx.createGain(); master.gain.value = 0.9; master.connect(ctx.destination);
        musicGain = ctx.createGain(); musicGain.gain.value = 0.25; musicGain.connect(master);
        sfxGain = ctx.createGain(); sfxGain.gain.value = 0.5; sfxGain.connect(master);
      }
      if (ctx.state === 'suspended') ctx.resume();
      started = true;
    }
    function envOsc(freq=440, dur=0.2, type='sine', gain=0.2, dest=sfxGain){
      if (!started) return;
      const o = ctx.createOscillator(); o.type = type; o.frequency.value = freq;
      const g = ctx.createGain(); g.gain.value = gain;
      o.connect(g); g.connect(dest);
      const t = ctx.currentTime;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(gain, t+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.start(t); o.stop(t+dur+0.02);
    }
    const SFX = {
      jump(){ envOsc(520, 0.12, 'square', 0.18); },
      coin(){ envOsc(900, 0.08, 'square', 0.15); envOsc(1200, 0.06, 'square', 0.12); },
      hit(){ envOsc(160, 0.1, 'sawtooth', 0.2); },
      attack(){ envOsc(420, 0.05, 'triangle', 0.18); },
      hurt(){ envOsc(140, 0.18, 'sawtooth', 0.25); },
      shoot(){ envOsc(760, 0.05, 'square', 0.18); envOsc(480, 0.06, 'triangle', 0.12); },
      win(){ envOsc(660, 0.16, 'sine', 0.22); envOsc(880, 0.18, 'sine', 0.22); },
      lose(){ envOsc(200, 0.3, 'sawtooth', 0.25); },
      stomp(){ envOsc(300, 0.07, 'triangle', 0.2); },
      bossPhase(){ envOsc(500, 0.35, 'sawtooth', 0.15, musicGain); },
      power(){ envOsc(1040, 0.2, 'sawtooth', 0.25); }
    };
    const Music = {
      playing: false,
      start(normal=true){
        if (!started || this.playing) return;
        this.playing = true;
        let step = 0;
        const tempo = normal? 250 : 180;
        musicInterval = setInterval(()=>{
          if (!state.audioOn) return;
          const base = normal ? 220 : 196;
          const pattern = normal ?
            [[0,4,7],[0,5,9],[0,4,7],[2,5,9],[0,3,7],[0,3,8],[0,3,7],[2,5,8]]
            :
            [[0,3,7],[0,4,7],[2,5,9],[0,3,6],[0,5,8],[2,5,9],[4,7,11],[2,6,9]];
          const chord = pattern[step % pattern.length];
          chord.forEach((semi, i)=>{
            const f = base * Math.pow(2, semi/12);
            envOsc(f, 0.16, i===0?'triangle':'sine', i===0?0.07:0.05, musicGain);
          });
          step++;
        }, tempo);
      },
      stop(){ if (musicInterval){ clearInterval(musicInterval); musicInterval=null; } this.playing=false; }
    };
    function setAudio(on){
      state.audioOn = on;
      audioToggleBtn.textContent = 'Audio: ' + (on?'On':'Off');
      if (!on) Music.stop(); else { resume(); Music.start(true); }
    }
    return { resume, SFX, Music, setAudio };
  })();

  audioToggleBtn.addEventListener('click', ()=>{
    if (!state.audioOn){ AudioSys.resume(); }
    AudioSys.setAudio(!state.audioOn);
  });

  // HUD corazones
  function renderHearts() {
    healthHud.innerHTML = '';
    for (let i=0;i<player.maxHp;i++) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('class','heart');
      svg.setAttribute('viewBox','0 0 32 28');
      svg.innerHTML = `<path d="M23.6,0c-3,0-4.9,1.8-7.6,4.7C13.3,1.8,11.4,0,8.4,0C3.8,0,0,3.7,0,8.2c0,4.9,3.8,8.4,9.5,13.4c1.5,1.3,3.1,2.6,4.8,4.1c1.7-1.5,3.3-2.8,4.8-4.1C28.2,16.6,32,13.1,32,8.2C32,3.7,28.2,0,23.6,0z" fill="${i<player.hp ? '#ef4444' : '#374151'}"/>`;
      healthHud.appendChild(svg);
    }
  }

  // ---- Niveles ----
  function mkLevel1(){ return {
    start: {x:60, y:-200},
    platforms: [{x:-200, y:300, w:1200, h:40},{x:350, y:220, w:120, h:16},{x:700, y:160, w:140, h:16},{x:1000, y:220, w:140, h:16}],
    coins: [{x:380,y:190,t:false},{x:730,y:130,t:false},{x:1030,y:190,t:false}],
    hearts: [{x:540, y:260, taken:false}],
    spikes: [{x:860, y:300, w:60, h:40}],
    enemies: [{type:'walker', x:920, y:264, w:28, h:24, dir:-1, left:900, right:1080, speed:70, hp:2, alive:true, iFrames:0}],
    goal: {x:1120, y:180, w:36, h:72},
    length: 1400
  };}

  function mkLevel2(){ return {
    start: {x:60, y:-160},
    platforms: [{x:-200, y:320, w:1200, h:40},{x:200, y:240, w:120, h:16},{x:600, y:200, w:160, h:16},{x:980, y:260, w:180, h:16}],
    coins: [{x:230,y:210,t:false},{x:630,y:170,t:false},{x:1010,y:230,t:false}],
    hearts: [{x:820, y:220, taken:false}],
    spikes: [{x:500, y:320, w:60, h:40},{x:850, y:320, w:60, h:40}],
    enemies: [{type:'turret', x:720, y:288, w:20, h:32, dir:1, fireCd:0.0, hp:3, alive:true, iFrames:0}],
    goal: {x:1160, y:220, w:36, h:72},
    length: 1400
  };}

  function mkBossLevel(){ return {
    start: {x:120, y:-200},
    platforms: [
      {x:-200, y:360, w:1800, h:40},
      {x:300, y:260, w:160, h:16},
      {x:600, y:260, w:160, h:16},
      {x:900, y:260, w:160, h:16},
      {x:1200, y:260, w:160, h:16},
    ],
    coins: [{x:340,y:230,t:false},{x:640,y:230,t:false},{x:940,y:230,t:false},{x:1240,y:230,t:false}],
    hearts: [{x:1500, y:320, taken:false}],
    spikes: [{x:760, y:360, w:60, h:40},{x:1040, y:360, w:60, h:40}],
    enemies: [],
    goal: {x:1600, y:320, w:0, h:0},
    length: 1800,
    boss: { x: 1250, y: 296, w: 56, h: 48, vx:0, vy:0, onGround:true, hp: 30, maxHp:30, phase:1, iFrames:0, atkCd:0, jumpCd:1.2 },
    power: { x: 1060, y: 320, w: 22, h: 22, taken: false }
  };}

  function buildLevels(){ return [mkLevel1(), mkLevel2(), mkBossLevel()]; }

  let levels = buildLevels();
  let cur = levels[state.levelIndex];
  const bullets = [];      // enemy bullets
  const bossBullets = [];  // boss bullets
  const shots = [];        // player cube shots

  function aabb(ax,ay,aw,ah,bx,by,bw,bh){ return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by; }

  // === NUEVO: hitbox del ataque cuerpo a cuerpo ===
  function getAttackBox(){
    // Caja de impacto delante del jugador, alineada con el sprite de ataque
    const w = 40, h = 28;
    const x = player.facing > 0 ? (player.x + player.w - 6) : (player.x - (w - 6));
    const y = player.y + 9;
    return {x, y, w, h};
  }

  function showOverlay(title, body, actions=[]) {
    ovTitle.textContent = title;
    ovBody.textContent = body;
    ovActions.innerHTML = '';
    actions.forEach(({label, onClick, ghost}) => {
      const b = document.createElement('button');
      b.textContent = label;
      if (ghost) b.classList.add('ghost');
      b.onclick = () => { onClick(); };
      ovActions.appendChild(b);
    });
    overlay.style.display = 'grid';
  }
  function hideOverlay(){ overlay.style.display = 'none'; }

  const LORE = `Bienvenido, papu.
El multiverso está infestado de brainrots.
Reúne moneditas, cuida tus corazones y vence al Mega Brainrot.
Tip: en el nivel del jefe hay un power-up para disparar cubitos (tecla C).`;

  function toMenu(){
    state.screen = 'menu';
    showOverlay('Papu Platformer', '¿Qué se arma, mi rey?', [
      {label:'Jugar de una', onClick: ()=>{ AudioSys.resume(); AudioSys.setAudio(true); hideOverlay(); startLevel(0); }},
      {label:'Elegir nivel (modo facha)', onClick: ()=> levelSelect() },
      {label:'Lore del Papu', onClick: ()=>{ showOverlay('Lore del Papu', LORE, [{label:'Volver', onClick: toMenu}]); }},
      {label: state.audioOn? 'Mute (shhhh)' : 'Prender audio', ghost:true, onClick: ()=>{ AudioSys.setAudio(!state.audioOn);} },
      {label:'Controles (cero ciencia)', ghost:true, onClick: ()=>{
        showOverlay('Controles', 'Flechitas: mover\nEspacio: salto/doble\nX: tunazo\nC: disparar cubitos (tras power)\nP: pausa · R: reiniciar', [
          {label:'Volver', onClick: toMenu}
        ]);
      }}
    ]);
  }

  function levelSelect(){
    const actions = [];
    for (let i=0;i<levels.length;i++){
      actions.push({label:`Nivel ${i+1}${i===2?' – Mega Brainrot':''}`, onClick: ()=>{ hideOverlay(); startLevel(i);} });
    }
    actions.push({label:'Volver', onClick: toMenu });
    showOverlay('Selector de niveles', 'Elegí tu dosis de tonterías:', actions);
  }

  // --- Start / reset ---
  function startLevel(idx){
    levels = buildLevels();
    state.levelIndex = idx;
    cur = levels[state.levelIndex];

    Object.assign(player, {x:cur.start.x, y:cur.start.y, vx:0, vy:0, onGround:false, canDouble:true, facing:1, hp: player.maxHp, hurtCd:0, hasBlaster:false, shootCd:0});
    Object.assign(state, {screen:'playing', coins:0, time:0, startedAt:performance.now(), camera:{x:0,y:0}});

    cur.coins.forEach(c=>c.t=false);
    cur.hearts.forEach(h=>h.taken=false);
    if (cur.enemies) cur.enemies.forEach(e=>{ e.alive=true; e.hp = e.type==='walker'? (e.hp||2) : (e.hp||3); e.iFrames=0; if (e.type==='walker'){ e.x=(e.left+e.right)/2; } });
    bullets.length = 0; bossBullets.length = 0; shots.length = 0;

    hideOverlay();
    renderHearts();
    bossFill.style.width = "100%";
    bossbar.style.display = (state.levelIndex===2) ? 'block' : 'none';

    if (state.audioOn) { AudioSys.Music.stop(); AudioSys.Music.start(state.levelIndex!==2); }
  }

  function nextLevel(){
    if (state.levelIndex + 1 >= levels.length) {
      state.screen = 'won';
      AudioSys.SFX.win();
      showOverlay('God, papu', `Tiempo total: ${state.time.toFixed(1)}s\nMoneditas: ${state.coins}`, [
        {label:'Rejugar desde el inicio', onClick: ()=>{ toMenu(); }}
      ]);
      AudioSys.Music.stop();
      return;
    }
    startLevel(state.levelIndex + 1);
  }

  function pause(){
    if (state.screen !== 'playing') return;
    state.screen = 'paused';
    showOverlay('Pausado mientra tanto', 'Hidratate, papu', [
      {label:'Seguir dándole', onClick: ()=>{ hideOverlay(); state.screen='playing'; }},
      {label:'Reiniciar nivel (por si acaso)', onClick: ()=>{ hideOverlay(); startLevel(state.levelIndex); }},
      {label:'Volver al menú', onClick: ()=>{ toMenu(); }}
    ]);
  }

  function damagePlayer(amount){
    if (player.hurtCd > 0) return;
    player.hp -= amount;
    player.hurtCd = 0.8;
    renderHearts();
    AudioSys.SFX.hurt();
    if (player.hp <= 0) {
      state.screen = 'lost';
      AudioSys.SFX.lose();
      showOverlay('Fuiste troleado', `Te quedaste sin corazones.\nCrono: ${state.time.toFixed(1)}s · Moneditas: ${state.coins}`, [
        {label:'Revancha', onClick: ()=>{ hideOverlay(); startLevel(state.levelIndex); }},
        {label:'Menú de papus', onClick: ()=>{ toMenu(); }}
      ]);
      AudioSys.Music.stop();
    }
  }

  function doAttack(){
    if (attack.cdLeft > 0 || attack.active || state.screen!=='playing') return;
    attack.active = true; attack.timer = attack.duration; attack.cdLeft = attack.cooldown;
    AudioSys.SFX.attack();
  }

  function shootCube(){
    if (!player.hasBlaster) return;
    if (player.shootCd > 0) return;
    const speed = 520;
    const dir = player.facing;
    const rotating = !player.onGround; // rota si se dispara en el aire
    shots.push({
      x: player.x + (dir>0 ? player.w+2 : -14), y: player.y + 16,
      vx: dir*speed, vy: 0, w: 14, h: 14,
      angle: 0, rotSpeed: rotating ? 12 : 0, rotating
    });
    player.shootCd = 0.22;
    AudioSys.SFX.shoot();
  }

  function bossStep(dt){
    const b = cur.boss; if (!b) return;
    if (b.iFrames>0) b.iFrames -= dt;
    b.atkCd -= dt; b.jumpCd -= dt;

    if (b.phase === 1) {
      const target = player.x + (player.facing>0? -50 : 50);
      const dir = Math.sign(target - b.x);
      b.vx = 160 * dir;
      if (Math.abs(target - b.x) < 20) b.vx = 0;
      if (b.atkCd<=0) { shootBoss(b, 3, 260); b.atkCd = 1.6; }
      if (b.jumpCd<=0) { b.vy = -680; b.jumpCd = 2.6; }
      if (b.hp <= b.maxHp*0.66) { b.phase = 2; AudioSys.SFX.bossPhase(); }
    } else if (b.phase === 2) {
      const dir = Math.sign(player.x - b.x);
      b.vx = 220 * dir;
      if (b.atkCd<=0) { shootBoss(b, 5, 300); b.atkCd = 1.3; }
      if (b.jumpCd<=0) { b.vy = -760; b.jumpCd = 2.0; }
      if (b.hp <= b.maxHp*0.33) { b.phase = 3; AudioSys.SFX.bossPhase(); }
    } else {
      const dir = Math.sign(player.x - b.x);
      b.vx = 300 * dir;
      if (b.atkCd<=0) { shootBoss(b, 7, 360); b.atkCd = 1.1; }
      if (b.jumpCd<=0) { b.vy = -820; b.jumpCd = 1.7; }
    }

    b.vy += 1800 * dt;
    b.x += b.vx * dt; b.y += b.vy * dt;
    const floor = cur.platforms[0];
    if (b.y + b.h > floor.y && b.x + b.w > floor.x && b.x < floor.x + floor.w) {
      b.y = floor.y - b.h; b.vy = 0; b.onGround = true;
    }
  }

  function shootBoss(b, count, speed){
    const baseAngle = Math.atan2((player.y - b.y), (player.x - b.x));
    const spread = Math.PI/6;
    for (let i=0;i<count;i++){
      const t = (i/(count-1)) - 0.5;
      const ang = baseAngle + t * spread;
      bossBullets.push({x:b.x + b.w/2, y:b.y + b.h/2, vx: Math.cos(ang)*speed, vy: Math.sin(ang)*speed, w:6, h:6});
    }
    AudioSys.SFX.shoot();
  }

  function step(dt){
    if (state.screen !== 'playing') return;
    state.time = (performance.now() - state.startedAt) / 1000;
    hudTimer.textContent = `Crono: ${state.time.toFixed(1)}s`;
    hudCoins.textContent = `Moneditas: ${state.coins}`;
    hudLevel.textContent = `Nivelazo: ${state.levelIndex+1}${state.levelIndex===2?' – Mega Brainrot':''}`;

    const left = keys.has('ArrowLeft') || touchLeft;
    const right = keys.has('ArrowRight') || touchRight;
    let wantJump = keys.has('Space') || keys.has(' ') || touchJump;
    const wantAtk = keys.has('KeyX') || touchAtk;
    const wantShoot = keys.has('KeyC');

    if (keys.has('KeyP')) { keys.delete('KeyP'); pause(); return; }
    if (keys.has('KeyR')) { keys.delete('KeyR'); startLevel(state.levelIndex); return; }

    if (left && !right) { player.vx = -MOVE; player.facing = -1; }
    else if (right && !left) { player.vx = MOVE; player.facing = 1; }
    else { player.vx *= player.onGround ? FRICTION : 0.98; if (Math.abs(player.vx) < 1) player.vx = 0; }

    if (wantJump) {
      if (player.onGround) { player.vy = -JUMP; player.onGround = false; player.canDouble = true; AudioSys.SFX.jump(); }
      else if (player.canDouble) { player.vy = -JUMP*0.9; player.canDouble = false; AudioSys.SFX.jump(); }
      wantJump = false; touchJump=false; keys.delete('Space'); keys.delete(' ');
    }
    if (wantAtk) { doAttack(); keys.delete('KeyX'); }
    if (wantShoot) { shootCube(); keys.delete('KeyC'); }
    if (player.shootCd > 0) player.shootCd -= dt;

    if (attack.cdLeft > 0) attack.cdLeft -= dt;
    if (attack.active) { attack.timer -= dt; if (attack.timer <= 0) attack.active = false; }
    if (player.hurtCd > 0) player.hurtCd -= dt;

    player.vy += G * dt;
    let nextX = player.x + player.vx * dt;
    let nextY = player.y + player.vy * dt;

    player.onGround = false;
    for (const p of cur.platforms) {
      const px = {x: nextX, y: player.y, w: player.w, h: player.h};
      if (aabb(px.x, px.y, px.w, px.h, p.x, p.y, p.w, p.h)) {
        if (player.vx > 0) nextX = p.x - player.w - 0.01; else if (player.vx < 0) nextX = p.x + p.w + 0.01;
        player.vx = 0;
      }
      const py = {x: nextX, y: nextY, w: player.w, h: player.h};
      if (aabb(py.x, py.y, py.w, py.h, p.x, p.y, p.w, p.h)) {
        if (player.vy > 0) { nextY = p.y - player.h - 0.01; player.vy = 0; player.onGround = true; }
        else if (player.vy < 0) { nextY = p.y + p.h + 0.01; player.vy = 0; }
      }
    }

    player.x = nextX; player.y = nextY;
    if (player.y > 900) damagePlayer(player.hp);

    for (const c of cur.coins) if (!c.t && aabb(player.x, player.y, player.w, player.h, c.x-8, c.y-8, 16, 16)) { c.t = true; state.coins++; AudioSys.SFX.coin(); }

    for (const h of cur.hearts) if (!h.taken && aabb(player.x, player.y, player.w, player.h, h.x-8, h.y-8, 16, 16)) {
      h.taken = true; player.hp = Math.min(player.maxHp, player.hp + 1); renderHearts();
    }

    // Power-up: pausa tutorial al abrir y despausa al cerrar
    if (state.levelIndex===2 && cur.power && !cur.power.taken) {
      if (aabb(player.x, player.y, player.w, player.h, cur.power.x-8, cur.power.y-8, cur.power.w+16, cur.power.h+16)) {
        cur.power.taken = true;
        player.hasBlaster = true;
        AudioSys.SFX.power();

        state.screen = 'paused';
        showOverlay('Power Cubitos', 'Agarraste el Cubito Supremo.\nPulsa C para disparar cubitos.\nLos cubos rotan si disparas en el aire.', [
          {label:'Ok', onClick: ()=>{ hideOverlay(); state.screen = 'playing'; }}
        ]);
      }
    }

    // Enemigos normales
    if (state.levelIndex < 2) {
      for (const e of cur.enemies) {
        if (!e.alive) continue;
        if (e.iFrames > 0) e.iFrames -= dt;

        if (e.type === 'walker') {
          e.x += e.speed * e.dir * dt;
          if (e.x < e.left) { e.x = e.left; e.dir = 1; }
          if (e.x > e.right) { e.x = e.right; e.dir = -1; }
        } else if (e.type === 'turret') {
          e.fireCd = (e.fireCd || 0) - dt;
          const dist = Math.abs(player.x - e.x);
          if (dist < 520 && e.fireCd <= 0) {
            const dir = player.x > e.x ? 1 : -1;
            bullets.push({x:e.x + (dir>0?e.w: -6), y:e.y+10, vx: 360*dir, vy:0, w:8, h:8});
            e.fireCd = 1.1;
            AudioSys.SFX.shoot();
          }
        }

        // Daño por contacto (pisotón)
        if (aabb(player.x, player.y, player.w, player.h, e.x, e.y, e.w, e.h)) {
          if (player.vy > 120) {
            e.hp -= 2; e.iFrames = 0.2;
            player.vy = -JUMP*0.6;
            if (e.hp <= 0) { e.alive = false; state.coins += 1; AudioSys.SFX.hit(); }
          } else {
            damagePlayer(1);
          }
        }

        // === NUEVO: daño por ataque cuerpo a cuerpo (X) ===
        if (attack.active && e.alive && e.iFrames <= 0) {
          const atk = getAttackBox();
          if (aabb(atk.x, atk.y, atk.w, atk.h, e.x, e.y, e.w, e.h)) {
            e.hp -= 1;
            e.iFrames = 0.2;
            AudioSys.SFX.hit();
            if (e.hp <= 0) { e.alive = false; state.coins += 1; }
          }
        }
      }
    } else {
      // Jefe
      const b = cur.boss;
      bossbar.style.display = 'block';
      bossFill.style.width = (100 * Math.max(0, b.hp) / b.maxHp) + '%';
      bossStep(dt);

      if (aabb(player.x, player.y, player.w, player.h, b.x, b.y, b.w, b.h)) {
        if (player.vy > 120) { b.hp -= 2; b.iFrames = 0.2; player.vy = -JUMP*0.6; AudioSys.SFX.stomp(); }
        else { damagePlayer(1); }
      }

      // === NUEVO: ataque cuerpo a cuerpo también daña al jefe ===
      if (attack.active && b.iFrames <= 0) {
        const atk = getAttackBox();
        if (aabb(atk.x, atk.y, atk.w, atk.h, b.x, b.y, b.w, b.h)) {
          b.hp -= 1;
          b.iFrames = 0.2;
          AudioSys.SFX.hit();
        }
      }

      // Cubitos vs jefe
      for (let i = shots.length - 1; i >= 0; i--) {
        const s = shots[i];
        if (aabb(s.x, s.y, s.w, s.h, b.x, b.y, b.w, b.h) && b.iFrames<=0) {
          b.hp -= 2;
          b.iFrames = 0.2;
          AudioSys.SFX.hit();
          shots.splice(i,1);
        }
      }

      // Balas del jefe
      for (let i = bossBullets.length - 1; i >= 0; i--) {
        const bb = bossBullets[i];
        bb.x += bb.vx * dt; bb.y += bb.vy * dt;
        if (aabb(player.x, player.y, player.w, player.h, bb.x, bb.y, bb.w, bb.h)) { damagePlayer(1); bossBullets.splice(i,1); continue; }
        let hit = false;
        for (const p of cur.platforms) { if (aabb(bb.x, bb.y, bb.w, bb.h, p.x, p.y, p.w, p.h)) { hit = true; break; } }
        if (hit || bb.x < -200 || bb.x > cur.length+200 || bb.y < -200 || bb.y > 1000) bossBullets.splice(i,1);
      }

      if (b.hp <= 0) {
        bossbar.style.display = 'none';
        state.screen = 'won';
        AudioSys.SFX.win();
        AudioSys.Music.stop();
        showOverlay('Le ganaste al Mega Brainrot', `Crono: ${state.time.toFixed(1)}s · Moneditas: ${state.coins}`, [
          {label:'Volver al menú', onClick: ()=>{ toMenu(); }}
        ]);
      }
    }

    // Balas enemigas
    for (let i = bullets.length - 1; i >= 0; i--) {
      const b = bullets[i];
      b.x += b.vx * dt; b.y += b.vy * dt;
      let hit = false;
      for (const p of cur.platforms) if (aabb(b.x, b.y, b.w, b.h, p.x, p.y, p.w, p.h)) { hit = true; break; }
      if (aabb(player.x, player.y, player.w, player.h, b.x, b.y, b.w, b.h)) { damagePlayer(1); hit = true; }
      if (hit || b.x < -400 || b.x > cur.length+400) bullets.splice(i,1);
    }

    // Cubitos del jugador
    for (let i = shots.length - 1; i >= 0; i--) {
      const s = shots[i];
      s.x += s.vx * dt; s.y += s.vy * dt;
      if (s.rotating) s.angle += s.rotSpeed * dt;

      let stop = false;
      for (const p of cur.platforms) {
        if (aabb(s.x, s.y, s.w, s.h, p.x, p.y, p.w, p.h)) { stop = true; break; }
      }
      if (state.levelIndex < 2) {
        for (const e of cur.enemies) {
          if (!e.alive) continue;
          if (aabb(s.x, s.y, s.w, s.h, e.x, e.y, e.w, e.h)) {
            e.hp -= 3; e.iFrames = 0.2; if (e.hp <= 0) { e.alive=false; state.coins+=1; }
            stop = true; break;
          }
        }
      }
      if (stop || s.x < -400 || s.x > cur.length+400 || s.y < -300 || s.y > 1200) shots.splice(i,1);
    }

    // Picos
    for (const s of cur.spikes) if (aabb(player.x, player.y, player.w, player.h, s.x, s.y, s.w, s.h)) damagePlayer(1);

    // Meta
    if (state.levelIndex < 2 && aabb(player.x, player.y, player.w, player.h, cur.goal.x, cur.goal.y, cur.goal.w, cur.goal.h)) {
      AudioSys.SFX.win();
      showOverlay('Nivel pasado, papu', `Crono: ${state.time.toFixed(1)}s · Moneditas: ${state.coins}`, [
        {label:'Siguiente', onClick: ()=>{ hideOverlay(); nextLevel(); }},
        {label:'Menú', onClick: ()=>{ toMenu(); }}
      ]);
      state.screen = 'paused';
    }

    // Cámara
    const marginX = 220;
    const centerX = state.camera.x + canvas.clientWidth/2;
    if (player.x - centerX > marginX) state.camera.x = player.x - marginX - canvas.clientWidth/2;
    if (centerX - player.x > marginX) state.camera.x = player.x + marginX - canvas.clientWidth/2;
    state.camera.x = Math.max(-300, Math.min(cur.length, state.camera.x));
  }

  function draw(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const camX = Math.floor(state.camera.x);

    // Fondo
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, '#0d1b2a'); g.addColorStop(1, '#111827');
    ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

    ctx.save(); ctx.translate(-camX, 0);

    // “estrellas”
    ctx.globalAlpha = .25;
    for (let i=0;i<80;i++) {
      const x = (i*97)%5000, y = (i*53)%h;
      ctx.fillStyle = '#dbeafe';
      ctx.fillRect(x*0.5, y*0.7 + 10*Math.sin((x+y+state.time*30)/200), 2,2);
    }
    ctx.globalAlpha = 1;

    // Plataformas
    for (const p of cur.platforms) {
      ctx.fillStyle = '#1f2937'; ctx.fillRect(p.x, p.y, p.w, p.h);
      ctx.fillStyle = '#334155'; ctx.fillRect(p.x, p.y, p.w, 4);
    }

    // Picos
    for (const s of cur.spikes) {
      ctx.fillStyle = '#8b1e2d'; const tH = s.h; const triW = 12; const n = Math.floor(s.w/triW);
      for (let i=0;i<n;i++){ const x = s.x + i*triW; ctx.beginPath(); ctx.moveTo(x, s.y+s.h); ctx.lineTo(x+triW/2, s.y+s.h - tH); ctx.lineTo(x+triW, s.y+s.h); ctx.closePath(); ctx.fill(); }
    }

    // Monedas
    for (const c of cur.coins) {
      if (c.t) continue;
      const f = SPR.coin[Math.floor((performance.now()/100)%SPR.coin.length)];
      drawSpr(f, c.x-8, c.y-8, 16, 16);
    }

    // Corazones (pickup)
    for (const htp of cur.hearts) {
      if (htp.taken) continue;
      drawSpr(SPR.heart[0], htp.x-8, htp.y-8, 16, 16);
    }

    // Power-up (boss)
    if (state.levelIndex===2 && cur.power && !cur.power.taken) {
      const t = (performance.now()/400)%(Math.PI*2);
      drawSpr(SPR.power[0], cur.power.x-10, cur.power.y-10, 20, 20, {rot:t});
    }

    // Enemigos
    if (state.levelIndex < 2) {
      for (const e of cur.enemies) {
        if (!e.alive) continue;
        if (e.type==='walker') {
          const f = SPR.walker[Math.floor((performance.now()/200)%SPR.walker.length)];
          drawSpr(f, e.x, e.y, e.w, e.h, {alpha: e.iFrames>0 ? 0.7 : 1});
        } else if (e.type==='turret') {
          const f = SPR.turret[Math.floor((performance.now()/300)%SPR.turret.length)];
          drawSpr(f, e.x, e.y, e.w, e.h, {alpha: e.iFrames>0 ? 0.7 : 1});
        }
      }
    } else {
      const b = cur.boss;
      const f = SPR.boss[Math.floor((performance.now()/250)%SPR.boss.length)];
      drawSpr(f, b.x, b.y, b.w, b.h, {alpha: b.iFrames>0 ? 0.7 : 1});
      for (const bb of bossBullets) drawSpr(SPR.bullet[0], bb.x, bb.y, bb.w, bb.h);
    }

    // Balas enemigas
    for (const b of bullets) drawSpr(SPR.bullet[0], b.x, b.y, b.w, b.h);

    // Jugador
    let pf = SPR.player_idle[ Math.floor((performance.now()/250)%SPR.player_idle.length) ];
    if (!player.onGround) pf = SPR.player_jump[0];
    else if (Math.abs(player.vx) > 1) pf = SPR.player_run[ Math.floor((performance.now()/120)%SPR.player_run.length) ];
    const flip = player.facing < 0;
    drawSpr(pf, player.x, player.y, player.w, player.h, {flip, alpha: player.hurtCd>0 ? 0.8 : 1});

    // Ataque cuerpo a cuerpo (sprite ancho)
    if (attack.active) {
      const af = SPR.player_attack[0];
      const aw = 54, ah = 46;
      const ax = player.facing>0 ? player.x + player.w - 6 : player.x - (aw - 6);
      drawSpr(af, ax, player.y, aw, ah, {flip});
    }

    // Disparos del jugador
    for (const s of shots) {
      drawSpr(SPR.cube[0], s.x, s.y, s.w, s.h, {rot: s.rotating ? s.angle : 0});
    }

    ctx.restore();
  }

  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now - last)/1000); last = now;
    step(dt); draw();
    requestAnimationFrame(loop);
  }

  // Comenzar cuando cargue el atlas
  loadAtlas('sprites.png').then(()=>{
    requestAnimationFrame(loop);
    toMenu();
  }).catch(err=>{
    showOverlay('Error', 'No se pudo cargar sprites.png\nColoca el archivo junto al HTML y recarga.', [
      {label:'Reintentar', onClick: ()=>location.reload()}
    ]);
  });

  window.addEventListener('keydown', (e)=>{
    if (state.screen==='menu' && (e.code==='Enter')) { AudioSys.resume(); AudioSys.setAudio(true); startLevel(0); hideOverlay(); }
  });
})();
</script>
</body>
</html>
